name: Telegram RSS Feed Automation

on:
  schedule:
    - cron: "*/5 * * * *"  # Runs every 5 minutes
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ‚úÖ Grants GitHub Actions permission to push changes

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: pip install flask telethon feedgen waitress google-cloud-storage

    - name: Debug Secrets (Check if GCP Secret Exists)
      run: |
        if [ -z "$GCP_SERVICE_ACCOUNT_JSON" ]; then
          echo "‚ùå ERROR: Google Cloud Service Account JSON secret is missing!"
          exit 1
        else
          echo "‚úÖ GCP Secret found! (First 100 chars only for verification)"
          echo "$GCP_SERVICE_ACCOUNT_JSON" | head -c 100
        fi
      env:
        GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}

    - name: Run Telegram RSS Feed Script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
        GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
      run: python main.py

    - name: Commit and Push Updated RSS Feed
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add docs/rss.xml docs/last_post.json
        git commit -m "üîÑ Auto-update RSS feed"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
